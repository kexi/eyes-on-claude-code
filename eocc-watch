#!/bin/bash
# eocc-watch - Eyes on Claude Code ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
#
# Usage: eocc-watch [options]
#   -f, --follow     ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
#   -n, --lines N    æœ€æ–°Nè¡Œã‚’è¡¨ç¤º
#   -j, --json       JSONã‚’ãã®ã¾ã¾è¡¨ç¤º
#   -s, --summary    ã‚µãƒãƒªãƒ¼è¡¨ç¤º

set -euo pipefail

LOG_DIR="${HOME}/.eocc/logs"
EVENTS_FILE="${LOG_DIR}/events.jsonl"
CONSOLE_FILE="${LOG_DIR}/console.log"

MODE="follow"
LINES=20
JSON_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--follow)
            MODE="follow"
            shift
            ;;
        -n|--lines)
            MODE="lines"
            LINES="$2"
            shift 2
            ;;
        -j|--json)
            JSON_MODE=true
            shift
            ;;
        -s|--summary)
            MODE="summary"
            shift
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆ
if [ ! -d "$LOG_DIR" ]; then
    echo "ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“: $LOG_DIR"
    echo "eocc-hook ã‚’è¨­å®šã—ã¦ Claude Code ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
    exit 1
fi

case $MODE in
    follow)
        echo "ğŸ“¡ Eyes on Claude Code - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ä¸­..."
        echo "   ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: $CONSOLE_FILE"
        echo "   Ctrl+C ã§çµ‚äº†"
        echo "----------------------------------------"
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        touch "$CONSOLE_FILE"
        
        # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
        tail -f "$CONSOLE_FILE"
        ;;
        
    lines)
        if $JSON_MODE; then
            tail -n "$LINES" "$EVENTS_FILE" 2>/dev/null | jq '.'
        else
            tail -n "$LINES" "$CONSOLE_FILE" 2>/dev/null
        fi
        ;;
        
    summary)
        echo "ğŸ“Š Eyes on Claude Code ã‚µãƒãƒªãƒ¼"
        echo "========================================"
        
        if [ ! -f "$EVENTS_FILE" ]; then
            echo "ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 0
        fi
        
        # ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°
        TOTAL=$(wc -l < "$EVENTS_FILE" | tr -d ' ')
        echo "ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°: $TOTAL"
        echo ""
        
        # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—åˆ¥é›†è¨ˆ
        echo "ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—åˆ¥:"
        jq -r '.event' "$EVENTS_FILE" 2>/dev/null | sort | uniq -c | sort -rn
        echo ""
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥é›†è¨ˆ
        echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥:"
        jq -r '.project_name' "$EVENTS_FILE" 2>/dev/null | sort | uniq -c | sort -rn
        echo ""
        
        # æœ€æ–°5ä»¶
        echo "æœ€æ–°5ä»¶:"
        tail -n 5 "$CONSOLE_FILE" 2>/dev/null
        ;;
esac
