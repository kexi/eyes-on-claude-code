#!/bin/bash
# eocc-hook - Eyes on Claude Code ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
#
# Usage: eocc-hook <event_type> [matcher]
#
# ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ ~/.claude/settings.json ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã€
# å…¨ã¦ã®Claude Codeã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¾ã™ã€‚

set -euo pipefail

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
LOG_DIR="${HOME}/.eocc/logs"
LOG_FILE="${LOG_DIR}/events.jsonl"
LATEST_FILE="${LOG_DIR}/latest.json"

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
mkdir -p "$LOG_DIR"

# å¼•æ•°
EVENT_TYPE="${1:-unknown}"
MATCHER="${2:-}"

# stdinã‹ã‚‰JSONã‚’èª­ã¿å–ã‚Š
# Note: Claude Code passes hook data via stdin as JSON
INPUT=""
if [ -t 0 ]; then
    # stdin is a terminal, no input
    INPUT='{}'
else
    # Read all stdin
    INPUT=$(cat 2>/dev/null || echo '{}')
fi

# å…¥åŠ›ãŒç©ºã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
if [ -z "$INPUT" ] || [ "$INPUT" = "" ]; then
    INPUT='{}'
fi

# ãƒ‡ãƒãƒƒã‚°: ç”Ÿã®stdinå…¥åŠ›ã‚’ãƒ­ã‚°ã«ä¿å­˜
echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] EVENT=$EVENT_TYPE MATCHER=$MATCHER INPUT=$INPUT" >> "${LOG_DIR}/stdin-debug.log"

# ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id // "unknown"' 2>/dev/null || echo "unknown")
MESSAGE=$(echo "$INPUT" | jq -r '.message // empty' 2>/dev/null || echo "")
NOTIFICATION_TYPE=$(echo "$INPUT" | jq -r '.notification_type // empty' 2>/dev/null || echo "")
TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // empty' 2>/dev/null || echo "")

# For notification events, use matcher as notification type if not in input
if [ "$EVENT_TYPE" = "notification" ] && [ -z "$NOTIFICATION_TYPE" ]; then
    NOTIFICATION_TYPE="$MATCHER"
fi

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æŠ½å‡ºï¼ˆCLAUDE_PROJECT_DIRã‹ã‚‰æœ€å¾Œã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåï¼‰
PROJECT_DIR="${CLAUDE_PROJECT_DIR:-unknown}"
PROJECT_NAME=$(basename "$PROJECT_DIR" 2>/dev/null || echo "unknown")

# ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
TIMESTAMP_LOCAL=$(date +%H:%M:%S)

# ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä½œæˆ
PAYLOAD=$(jq -nc \
  --arg event "$EVENT_TYPE" \
  --arg matcher "$MATCHER" \
  --arg project_dir "$PROJECT_DIR" \
  --arg project_name "$PROJECT_NAME" \
  --arg session_id "$SESSION_ID" \
  --arg message "$MESSAGE" \
  --arg notification_type "$NOTIFICATION_TYPE" \
  --arg tool_name "$TOOL_NAME" \
  --arg timestamp "$TIMESTAMP" \
  --argjson input "$INPUT" \
  '{
    timestamp: $timestamp,
    event: $event,
    matcher: $matcher,
    project_name: $project_name,
    project_dir: $project_dir,
    session_id: $session_id,
    message: $message,
    notification_type: $notification_type,
    tool_name: $tool_name,
    raw_input: $input
  }' 2>/dev/null || echo '{"error": "failed to create payload"}')

# JSONLãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜
echo "$PAYLOAD" >> "$LOG_FILE"

# æœ€æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
echo "$PAYLOAD" > "$LATEST_FILE"

# ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
# ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸçµµæ–‡å­—
case "$EVENT_TYPE" in
    notification)
        case "$NOTIFICATION_TYPE" in
            permission_prompt) EMOJI="ðŸ”" ;;
            idle_prompt) EMOJI="â³" ;;
            *) EMOJI="ðŸ””" ;;
        esac
        ;;
    stop) EMOJI="âœ…" ;;
    session_start) EMOJI="ðŸš€" ;;
    session_end) EMOJI="ðŸ" ;;
    pre_tool_use) EMOJI="ðŸ”§" ;;
    post_tool_use) EMOJI="ðŸ“" ;;
    *) EMOJI="ðŸ“Œ" ;;
esac

# ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡ºåŠ›ï¼ˆstderrã«å‡ºåŠ›ã—ã¦Claudeã®ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ±šã•ãªã„ï¼‰
echo "[$TIMESTAMP_LOCAL] $EMOJI $PROJECT_NAME: $EVENT_TYPE${MATCHER:+ ($MATCHER)}${MESSAGE:+ - $MESSAGE}" >> "${LOG_DIR}/console.log"

exit 0
